<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Instruments</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; background:#f5f7fa; margin:0; }
    header { background:#0d6efd; color:#fff; padding:0.75rem 1.5rem; }
    .header-inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:12px; }
    .back-btn { border:none; background:rgba(255,255,255,0.12); color:#fff; padding:0.45rem 0.9rem; border-radius:999px; cursor:pointer; }
    .header-title { flex:1; text-align:center; font-weight:600; font-size:1.5rem; }
    .container { max-width:1200px; margin:2rem auto; padding:2rem; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .top-bar h2 { color:#0d6efd; margin:0; }
    .top-bar button { background:#0d6efd; color:#fff; border:none; padding:0.6rem 1rem; border-radius:8px; cursor:pointer; }

    form { display:none; grid-template-columns:1fr 1fr; gap:1rem; margin:1rem 0 2rem; }
    form.active { display:grid; }
    form input, form select, form button, form textarea {
      padding:0.8rem;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:0.95rem;
      font-family:'Inter',sans-serif;
    }
    #detailsInput { grid-column:span 2; height:150px; resize:vertical; }
    form button[type="submit"] { grid-column:span 2; background:#0d6efd; color:#fff; border:none; cursor:pointer; }

    table { width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:1rem; }
    thead th { padding:0.8rem; background:#f0f4f8; border-bottom:1px solid #ddd; text-align:left; }
    tbody tr { background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    td { padding:0.8rem; border-top:1px solid #eee; border-bottom:1px solid #eee; vertical-align:top; }
    tbody tr td:first-child { border-left:1px solid #eee; border-radius:8px 0 0 8px; }
    tbody tr td:last-child { border-right:1px solid #eee; border-radius:0 8px 8px 0; }
    .actions { white-space:nowrap; }
    .actions button { margin-right:0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; }
    .edit-btn { background:#ffc107; }
    .delete-btn { background:#dc3545; color:#fff; }
    .pagination { margin-top:1rem; text-align:center; }
    .pagination button { margin:0 0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:6px; background:#0d6efd; color:#fff; cursor:pointer; }

    .collapse-toggle { cursor:pointer; color:#0d6efd; font-weight:600; font-size:0.9rem; margin-bottom:0.25rem; user-select:none; }
    .details-content, .optional-content, .config-content { display:none; font-size:0.9rem; margin-top:0.5rem; }
    .price-cell { font-weight:600; white-space:nowrap; }

    .modal { display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:1000; width:650px; }
    .modal h3 { margin-bottom:1rem; }
    .modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .modal input, .modal select, .modal textarea {
      padding:0.8rem;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:0.95rem;
      font-family:'Inter',sans-serif;
    }
    .modal textarea { grid-column:span 2; resize:vertical; }
    .modal-actions { margin-top:1rem; text-align:right; }
    .modal-actions button { padding:0.6rem 1rem; border-radius:8px; border:none; cursor:pointer; }
    .save-btn { background:#0d6efd; color:#fff; }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" onclick="goBack()">← Back</button>
    <div class="header-title">QMS - Instruments</div>
  </div>
</header>

<div class="container">
  <div class="top-bar">
    <h2>Instrument Master</h2>
    <button onclick="toggleForm()">Add Instrument</button>
  </div>

  <form id="instrumentForm">
    <input type="text" id="description" placeholder="Instrument Description" required>
    <textarea id="detailsInput" placeholder="First line = main item name&#10;Next lines = sub details, each on its own line"></textarea>
    <input type="text" id="origin" placeholder="Country Of Origin">
    <input type="text" id="catalog" placeholder="Catalog Reference">
    <input type="text" id="hsn" placeholder="HSN Code (1234 5678)" maxlength="9">

    <select id="additional">
      <option value="">Includes Additional Item?</option>
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>

    <select id="configuration">
      <option value="">Includes Configuration?</option>
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>

    <input type="text" id="instrumentCode" placeholder="Instrument Code (for quotes)">
    <input type="text" id="unitPrice" placeholder="Basic / Unit Price (₹)">
    <input type="text" id="gstType" placeholder="GST Type">
    <input type="number" id="gstPercent" placeholder="GST %">

    <button type="submit">Save Instrument</button>
  </form>

  <table id="instrumentTable">
    <thead>
      <tr>
        <th>Description</th>
        <th>Details</th>
        <th>Origin</th>
        <th>Catalog</th>
        <th>HSN</th>
        <th>Additional</th>
        <th>Config</th>
        <th>Code</th>
        <th>Price</th>
        <th>GST Type</th>
        <th>GST %</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">Prev</button>
    <span id="pageInfo"></span>
    <button onclick="nextPage()">Next</button>
  </div>
</div>

<!-- Optional Item Modal -->
<div id="optionalItemModal" class="modal">
  <h3>Add Optional Item</h3>
  <div class="modal-grid">
    <select id="existingAdditionalSelect">
      <option value="">-- Reuse Existing Additional Item --</option>
    </select>

    <div></div>

    <input type="text" id="optItemId" placeholder="Item ID">
    <input type="text" id="optItemCode" placeholder="Item Code">

    <!-- multiline item name / description -->
    <textarea id="optItemName" rows="4"
      placeholder="First line = item name&#10;Next lines = sub details, each on its own line"></textarea>

    <input type="text" id="optCatalogRef" placeholder="Catalog Reference Number">
    <input type="text" id="optHSN" placeholder="HSN Code (1234 5678)" maxlength="9">
    <input type="text" id="optOrigin" placeholder="Country Of Origin">
    <input type="text" id="optPrice" placeholder="Unit Price (₹)">
  </div>
  <div class="modal-actions">
    <button class="save-btn" onclick="saveOptionalItem()">Save</button>
    <button onclick="closeOptionalModal()">Cancel</button>
  </div>
</div>

<!-- Configuration Item Modal -->
<div id="configItemModal" class="modal">
  <h3>Add Configuration Item</h3>
  <div class="modal-grid">
    <select id="existingConfigSelect">
      <option value="">-- Reuse Existing Config Item --</option>
    </select>

    <div></div>

    <input type="text" id="cfgItemId" placeholder="Item ID">
    <input type="text" id="cfgItemCode" placeholder="Item Code">

    <!-- multiline item name / description -->
    <textarea id="cfgItemName" rows="4"
      placeholder="First line = item name&#10;Next lines = sub details, each on its own line"></textarea>

    <input type="text" id="cfgCatalogRef" placeholder="Catalog Reference Number">
    <input type="text" id="cfgHSN" placeholder="HSN Code (1234 5678)" maxlength="9">
    <input type="text" id="cfgOrigin" placeholder="Country Of Origin">
    <input type="text" id="cfgQty" placeholder="Qty" value="Included">
    <input type="text" id="cfgUP" placeholder="UP-INR" value="Included">
    <input type="text" id="cfgTP" placeholder="TP-INR" value="Included">
  </div>
  <div class="modal-actions">
    <button class="save-btn" onclick="saveConfigItem()">Save</button>
    <button onclick="closeConfigModal()">Cancel</button>
  </div>
</div>

<script>
  const form = document.getElementById('instrumentForm');
  const tableBody = document.querySelector('#instrumentTable tbody');
  const pageInfo = document.getElementById('pageInfo');
  const hsnInput = document.getElementById('hsn');
  const unitPriceInput = document.getElementById('unitPrice');
  const additionalSelect = document.getElementById('additional');
  const configurationSelect = document.getElementById('configuration');
  const detailsInput = document.getElementById('detailsInput');

  let instruments = JSON.parse(localStorage.getItem('instruments') || '[]');
  let currentPage = 1;
  const pageSize = 10;
  let editIndex = null;
  let optionalItems = [];
  let configurationItems = [];

  function goBack(){ if(window.history.length>1) window.history.back(); }
  function toggleForm(){ form.classList.toggle('active'); }

  hsnInput.addEventListener('input', () => {
    let digits = hsnInput.value.replace(/\D/g,'').slice(0,8);
    if(digits.length>4) digits = digits.slice(0,4)+' '+digits.slice(4);
    hsnInput.value = digits;
  });

  unitPriceInput.addEventListener('input', () => {
    let digits = unitPriceInput.value.replace(/[^\d]/g,'');
    if(!digits){ unitPriceInput.value=''; return; }
    const num = parseInt(digits,10);
    unitPriceInput.value = '₹ '+num.toLocaleString('en-IN');
  });

  function parsePriceValue(v){
    const digits = (v||'').replace(/[^\d]/g,'');
    return digits ? parseInt(digits,10) : 0;
  }

  // instrument details: first line header, others bullets
  function buildDetailsHTML(rawText) {
    const lines = rawText
      .split('\n')
      .map(l => l.trim())
      .filter(l => l);
    if (!lines.length) return '';
    const header = lines[0];
    const subs = lines.slice(1);
    if (!subs.length) {
      return `<p><strong>${header}</strong></p>`;
    }
    const subsHtml = subs.map(line => `<li>${line}</li>`).join('');
    return `
      <p><strong>${header}</strong></p>
      <ul>
        ${subsHtml}
      </ul>
    `;
  }

  /* MASTER REGISTRIES */

  function getConfigItemMaster() {
    return JSON.parse(localStorage.getItem('configItemMaster') || '[]');
  }
  function saveConfigItemToMaster(item) {
    const master = getConfigItemMaster();
    master.push(item);
    localStorage.setItem('configItemMaster', JSON.stringify(master));
  }
  function isDuplicateConfigItem(newItem) {
    const master = getConfigItemMaster();
    return master.some(item =>
      item.code === newItem.code &&
      item.name === newItem.name &&
      item.hsn === newItem.hsn
    );
  }

  function getAdditionalItemMaster() {
    return JSON.parse(localStorage.getItem('additionalItemMaster') || '[]');
  }
  function saveAdditionalItemToMaster(item) {
    const master = getAdditionalItemMaster();
    master.push(item);
    localStorage.setItem('additionalItemMaster', JSON.stringify(master));
  }
  function isDuplicateAdditionalItem(newItem) {
    const master = getAdditionalItemMaster();
    return master.some(item =>
      item.code === newItem.code &&
      item.name === newItem.name &&
      item.hsn === newItem.hsn
    );
  }

  /* OPTIONAL MODAL */

  additionalSelect.addEventListener('change', function(){
    if(this.value==='Yes') openOptionalModal();
  });

  function openOptionalModal() {
    populateExistingAdditionalDropdown();
    document.getElementById('optionalItemModal').style.display='block';
  }
  function closeOptionalModal(){
    document.getElementById('optionalItemModal').style.display='none';
  }

  const optHSNInput = document.getElementById('optHSN');
  optHSNInput.addEventListener('input', ()=>{
    let d = optHSNInput.value.replace(/\D/g,'').slice(0,8);
    if(d.length>4) d = d.slice(0,4)+' '+d.slice(4);
    optHSNInput.value = d;
  });
  const optPriceInput = document.getElementById('optPrice');
  optPriceInput.addEventListener('input', function(){
    let raw = this.value.replace(/[^\d]/g,'');
    this.value = raw ? '₹ '+parseFloat(raw).toLocaleString('en-IN') : '';
  });

  function populateExistingAdditionalDropdown() {
    const select = document.getElementById('existingAdditionalSelect');
    select.innerHTML = '<option value="">-- Reuse Existing Additional Item --</option>';
    const master = getAdditionalItemMaster();
    master.forEach((item, idx) => {
      const firstLine = (item.name || '').split('\n')[0] || '';
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${item.code} - ${firstLine}`;
      select.appendChild(opt);
    });

    select.onchange = function () {
      const masterNow = getAdditionalItemMaster();
      const selected = masterNow[this.value];
      if (selected) {
        document.getElementById('optItemId').value     = selected.id || '';
        document.getElementById('optItemCode').value   = selected.code || '';
        document.getElementById('optItemName').value   = selected.name || '';
        document.getElementById('optCatalogRef').value = selected.catalog || '';
        document.getElementById('optHSN').value        = selected.hsn || '';
        document.getElementById('optOrigin').value     = selected.origin || '';
        document.getElementById('optPrice').value      = selected.price || '';
      }
    };
  }

  function saveOptionalItem(){
    const hsn = optHSNInput.value.trim();
    if(!/^\d{4}\s\d{4}$/.test(hsn)){
      alert('HSN Code must be in format: 1234 5678');
      return;
    }

    const newItem = {
      id:    document.getElementById('optItemId').value,
      code:  document.getElementById('optItemCode').value,
      name:  document.getElementById('optItemName').value, // multiline
      catalog: document.getElementById('optCatalogRef').value,
      hsn,
      origin: document.getElementById('optOrigin').value,
      price: document.getElementById('optPrice').value
    };

    optionalItems.push({...newItem});

    if (!isDuplicateAdditionalItem(newItem)) {
      saveAdditionalItemToMaster(newItem);
    }

    closeOptionalModal();
  }

  /* CONFIG MODAL */

  configurationSelect.addEventListener('change', function(){
    if(this.value==='Yes') openConfigModal();
  });

  function openConfigModal(){
    populateExistingConfigDropdown();
    document.getElementById('configItemModal').style.display='block';
  }
  function closeConfigModal(){
    document.getElementById('configItemModal').style.display='none';
  }

  const cfgHSNInput = document.getElementById('cfgHSN');
  cfgHSNInput.addEventListener('input', ()=>{
    let d = cfgHSNInput.value.replace(/\D/g,'').slice(0,8);
    if(d.length>4) d = d.slice(0,4)+' '+d.slice(4);
    cfgHSNInput.value = d;
  });

  function populateExistingConfigDropdown() {
    const select = document.getElementById('existingConfigSelect');
    select.innerHTML = '<option value="">-- Reuse Existing Config Item --</option>';
    const master = getConfigItemMaster();
    master.forEach((item, idx) => {
      const firstLine = (item.name || '').split('\n')[0] || '';
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${item.code} - ${firstLine}`;
      select.appendChild(opt);
    });

    select.onchange = function () {
      const masterNow = getConfigItemMaster();
      const selected = masterNow[this.value];
      if (selected) {
        document.getElementById('cfgItemId').value     = selected.id || '';
        document.getElementById('cfgItemCode').value   = selected.code || '';
        document.getElementById('cfgItemName').value   = selected.name || '';
        document.getElementById('cfgCatalogRef').value = selected.catalog || '';
        document.getElementById('cfgHSN').value        = selected.hsn || '';
        document.getElementById('cfgOrigin').value     = selected.origin || '';
        document.getElementById('cfgQty').value        = selected.qty || 'Included';
        document.getElementById('cfgUP').value         = selected.upInr || 'Included';
        document.getElementById('cfgTP').value         = selected.tpInr || 'Included';
      }
    };
  }

  function saveConfigItem(){
    const hsn = cfgHSNInput.value.trim();
    if(!/^\d{4}\s\d{4}$/.test(hsn)){
      alert('HSN Code must be in format: 1234 5678');
      return;
    }

    const qtyInput = document.getElementById('cfgQty');
    const upInput  = document.getElementById('cfgUP');
    const tpInput  = document.getElementById('cfgTP');

    const newItem = {
      id:    document.getElementById('cfgItemId').value,
      code:  document.getElementById('cfgItemCode').value,
      name:  document.getElementById('cfgItemName').value, // multiline
      catalog: document.getElementById('cfgCatalogRef').value,
      hsn,
      origin: document.getElementById('cfgOrigin').value,
      qty:   (qtyInput.value.trim() || 'Included'),
      upInr: (upInput.value.trim() || 'Included'),
      tpInr: (tpInput.value.trim() || 'Included')
    };

    configurationItems.push({...newItem});

    if (!isDuplicateConfigItem(newItem)) {
      saveConfigItemToMaster(newItem);
    }

    closeConfigModal();
  }

  /* MAIN FORM SAVE */

  form.addEventListener('submit', e=>{
    e.preventDefault();
    const detailsHTML = buildDetailsHTML(detailsInput.value);
    const instrument = {
      description: document.getElementById('description').value,
      details: detailsHTML,
      origin: document.getElementById('origin').value,
      catalog: document.getElementById('catalog').value,
      hsn: hsnInput.value,
      additional: additionalSelect.value,
      configuration: configurationSelect.value,
      instrumentCode: document.getElementById('instrumentCode').value,
      unitPrice: parsePriceValue(unitPriceInput.value),
      gstType: document.getElementById('gstType').value,
      gstPercent: document.getElementById('gstPercent').value,
      optionalItems:[...optionalItems],
      configurationItems:[...configurationItems]
    };
    if(editIndex!==null){
      instruments[editIndex]=instrument;
      editIndex=null;
    } else {
      instruments.push(instrument);
    }
    localStorage.setItem('instruments', JSON.stringify(instruments));
    form.reset(); unitPriceInput.value='';
    optionalItems=[]; configurationItems=[];
    form.classList.remove('active');
    renderTable();
  });

  function formatPriceDisplay(v){ return '₹ '+Number(v||0).toLocaleString('en-IN'); }

  function renderTable(){
    tableBody.innerHTML='';
    const start=(currentPage-1)*pageSize, end=start+pageSize;
    instruments.slice(start,end).forEach((inst,i)=>{
      const idx = start+i;
      const hasOptional = inst.additional==='Yes' && inst.optionalItems && inst.optionalItems.length;
      const hasConfig = inst.configuration==='Yes' && inst.configurationItems && inst.configurationItems.length;

      const row=document.createElement('tr');
      row.innerHTML=`
        <td>${inst.description}</td>
        <td>
          <div class="collapse-toggle" onclick="toggleDetails(this)">Details</div>
          <div class="details-content">${inst.details||''}</div>
        </td>
        <td>${inst.origin||''}</td>
        <td>${inst.catalog||''}</td>
        <td>${inst.hsn||''}</td>
        <td>${
          hasOptional
            ? `<div class="collapse-toggle" onclick="toggleOptional(this)">▶ Additional Items</div>
               <div class="optional-content">${
                 inst.optionalItems.map(it=>{
                   const lines = (it.name || '').split('\n');
                   const title = lines[0] || 'Item';
                   const subs  = lines.slice(1);
                   return `
                     <div style="margin-bottom:0.3rem;">
                       <strong>${title}</strong>${it.code?` (${it.code})`:''}${subs.length ? '<br>'+subs.join('<br>') : ''} – ${it.price||''}
                     </div>`;
                 }).join('')
               }</div>`
            : (inst.additional||'')
        }</td>
        <td>${
          hasConfig
            ? `<div class="collapse-toggle" onclick="toggleConfig(this)">▶ Configuration Items</div>
               <div class="config-content">${
                 inst.configurationItems.map(it=>{
                   const lines = (it.name || '').split('\n');
                   const title = lines[0] || 'Item';
                   const subs  = lines.slice(1);
                   return `
                     <div style="margin-bottom:0.3rem;">
                       <strong>${title}</strong>${it.code?` (${it.code})`:''}${subs.length ? '<br>'+subs.join('<br>') : ''}
                       – Qty: ${it.qty || 'Included'}, UP: ${it.upInr || 'Included'}, TP: ${it.tpInr || 'Included'}
                     </div>`;
                 }).join('')
               }</div>`
            : (inst.configuration||'')
        }</td>
        <td>${inst.instrumentCode||''}</td>
        <td class="price-cell">${formatPriceDisplay(inst.unitPrice)}</td>
        <td>${inst.gstType||''}</td>
        <td>${inst.gstPercent||''}</td>
        <td class="actions">
          <button class="edit-btn" onclick="editInstrument(${idx})">Edit</button>
          <button class="delete-btn" onclick="deleteInstrument(${idx})">Delete</button>
        </td>`;
      tableBody.appendChild(row);
    });
    pageInfo.textContent=`Page ${currentPage} of ${Math.ceil(instruments.length/pageSize)||1}`;
  }

  function toggleDetails(el){
    const d=el.nextElementSibling;
    const v=d.style.display==='block';
    d.style.display=v?'none':'block';
    el.textContent=v?'Details':'Hide details';
  }
  function toggleOptional(el){
    const d=el.nextElementSibling;
    const v=d.style.display==='block';
    d.style.display=v?'none':'block';
    el.textContent=v?'▶ Additional Items':'▼ Additional Items';
  }
  function toggleConfig(el){
    const d=el.nextElementSibling;
    const v=d.style.display==='block';
    d.style.display=v?'none':'block';
    el.textContent=v?'▶ Configuration Items':'▼ Configuration Items';
  }

  function editInstrument(i){
    const inst=instruments[i];
    document.getElementById('description').value=inst.description;
    document.getElementById('origin').value=inst.origin||'';
    document.getElementById('catalog').value=inst.catalog||'';
    hsnInput.value=inst.hsn||'';
    additionalSelect.value=inst.additional||'';
    configurationSelect.value=inst.configuration||'';
    document.getElementById('instrumentCode').value=inst.instrumentCode||'';
    unitPriceInput.value=formatPriceDisplay(inst.unitPrice);
    document.getElementById('gstType').value=inst.gstType||'';
    document.getElementById('gstPercent').value=inst.gstPercent||'';
    detailsInput.value = ''; // raw text is not stored; you can enhance later if needed

    optionalItems = inst.optionalItems ? [...inst.optionalItems]:[];
    configurationItems = inst.configurationItems ? [...inst.configurationItems]:[];
    editIndex=i;
    form.classList.add('active');
  }

  function deleteInstrument(i){
    instruments.splice(i,1);
    localStorage.setItem('instruments', JSON.stringify(instruments));
    const maxPage=Math.max(1,Math.ceil(instruments.length/pageSize));
    if(currentPage>maxPage) currentPage=maxPage;
    renderTable();
  }

  function nextPage(){ if(currentPage*pageSize<instruments.length){ currentPage++; renderTable(); } }
  function prevPage(){ if(currentPage>1){ currentPage--; renderTable(); } }

  renderTable();
</script>
</body>
</html>
